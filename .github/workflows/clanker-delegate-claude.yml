name: Clanker Delegate (Claude Code)
on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Task prompt from Clanker'
        required: true
      branch_name:
        description: 'Branch name for the PR'
        required: true
jobs:
  delegate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "claude[bot]"
          git config user.email "claude[bot]@users.noreply.github.com"

      - name: Create branch
        run: |
          git checkout -b "${{ inputs.branch_name }}"

      - name: Install Claude Code
        run: |
          curl -fsSL https://bun.sh/install | bash
          export PATH="$HOME/.bun/bin:$PATH"
          npm install -g @anthropic-ai/claude-cli

      - name: Run Claude Code
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude "${{ inputs.prompt }}" --no-interactive

      - name: Commit changes
        run: |
          if git diff --quiet; then
            echo "No changes detected"
          else
            git add -A
            git commit -m "feat: $(echo '${{ inputs.prompt }}' | head -c 50)..."
          fi

      - name: Push branch and create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin "${{ inputs.branch_name }}"
          gh pr create \
            --base master \
            --head "${{ inputs.branch_name }}" \
            --title "Claude: $(echo '${{ inputs.prompt }}' | head -c 60)..." \
            --body "Automated changes from Claude Code delegation.

**Prompt:** ${{ inputs.prompt }}

Please review and approve/request changes as needed."
